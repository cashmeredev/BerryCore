#!/bin/sh
# BerryPy Launcher for BerryCore
# Starts the BerryPy app manager on port 8001

BERRYPY_DIR="${NATIVE_TOOLS}/share/berrypy"
BERRYPY_LOG="${BERRYPY_DIR}/berrypy.log"
BERRYPY_PID="${BERRYPY_DIR}/berrypy.pid"

# Ensure BerryPy-managed app paths are available
# BerryPy installs web apps to ~/apps/ and CLI apps to ~/usr/local/bin/
export PATH="$HOME/usr/local/bin:$PATH"
export LD_LIBRARY_PATH="$HOME/usr/local/lib:$LD_LIBRARY_PATH"

usage() {
    cat << HELP
BerryPy - BlackBerry App Platform Manager

Usage: berrypy [command]

Commands:
    start       Start BerryPy server (default)
    stop        Stop BerryPy server
    restart     Restart BerryPy server
    status      Check if BerryPy is running
    logs        Show recent logs
    url         Show the access URL
    update      Update BerryPy to the latest version

Examples:
    berrypy start          # Start the server
    berrypy                # Same as start
    berrypy status         # Check if running
    berrypy update         # Update to latest version

Once started, access BerryPy at: http://127.0.0.1:8001

HELP
}

start_berrypy() {
    if [ -f "$BERRYPY_PID" ]; then
        PID=$(cat "$BERRYPY_PID")
        if ps -p "$PID" > /dev/null 2>&1; then
            echo "BerryPy is already running (PID: $PID)"
            echo "Access at: http://127.0.0.1:8001"
            return 0
        else
            # Stale PID file
            rm -f "$BERRYPY_PID"
        fi
    fi
    
    echo "Starting BerryPy..."
    cd "$BERRYPY_DIR"
    nohup python3 taskapp.py >> "$BERRYPY_LOG" 2>&1 &
    echo $! > "$BERRYPY_PID"
    
    # Wait a moment and verify it started
    sleep 2
    if ps -p $(cat "$BERRYPY_PID") > /dev/null 2>&1; then
        echo "✓ BerryPy started successfully!"
        echo ""
        echo "  Access at: http://127.0.0.1:8001"
        echo "  View logs: berrypy logs"
        echo "  Stop with: berrypy stop"
        echo ""
    else
        echo "✗ Failed to start BerryPy. Check logs:"
        echo "  berrypy logs"
        rm -f "$BERRYPY_PID"
        exit 1
    fi
}

stop_berrypy() {
    if [ ! -f "$BERRYPY_PID" ]; then
        echo "BerryPy is not running (no PID file)"
        return 0
    fi
    
    PID=$(cat "$BERRYPY_PID")
    if ! ps -p "$PID" > /dev/null 2>&1; then
        echo "BerryPy is not running (stale PID file)"
        rm -f "$BERRYPY_PID"
        return 0
    fi
    
    echo "Stopping BerryPy (PID: $PID)..."
    kill "$PID" 2>/dev/null || true
    
    # Wait for process to stop (max 5 seconds)
    for i in 1 2 3 4 5; do
        if ! ps -p "$PID" > /dev/null 2>&1; then
            echo "✓ BerryPy stopped successfully"
            rm -f "$BERRYPY_PID"
            return 0
        fi
        sleep 1
    done
    
    # Force kill if still running
    echo "Force stopping BerryPy..."
    kill -9 "$PID" 2>/dev/null || true
    rm -f "$BERRYPY_PID"
    echo "✓ BerryPy stopped"
}

status_berrypy() {
    if [ ! -f "$BERRYPY_PID" ]; then
        echo "Status: Not running"
        return 1
    fi
    
    PID=$(cat "$BERRYPY_PID")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "Status: Running (PID: $PID)"
        echo "URL: http://127.0.0.1:8001"
        echo "Logs: $BERRYPY_LOG"
        return 0
    else
        echo "Status: Not running (stale PID file)"
        rm -f "$BERRYPY_PID"
        return 1
    fi
}

show_logs() {
    if [ ! -f "$BERRYPY_LOG" ]; then
        echo "No logs found at $BERRYPY_LOG"
        return 1
    fi
    
    echo "=== BerryPy Logs (last 50 lines) ==="
    tail -50 "$BERRYPY_LOG"
}

update_berrypy() {
    echo "BerryPy Update Manager"
    echo "======================"
    echo ""
    
    # Check if BerryPy is running
    WAS_RUNNING=0
    if [ -f "$BERRYPY_PID" ]; then
        PID=$(cat "$BERRYPY_PID")
        if ps -p "$PID" > /dev/null 2>&1; then
            WAS_RUNNING=1
            echo "→ Stopping BerryPy for update..."
            stop_berrypy
            echo ""
        fi
    fi
    
    # Download latest version
    UPDATE_URL="http://berrystore.sw7ft.com/updates/berrypy/latest.zip"
    TEMP_UPDATE="/tmp/berrypy-update-$$.zip"
    
    echo "→ Downloading latest BerryPy version..."
    if command -v curl >/dev/null 2>&1; then
        curl -k -L -o "$TEMP_UPDATE" "$UPDATE_URL" 2>&1 | grep -o '[0-9]*\.[0-9]' | tail -1 | \
        while read pct; do printf "\r  Progress: %.0f%%" "$pct"; done
        printf "\r  Progress: 100%%\n"
        DOWNLOAD_EXIT=$?
    elif command -v wget >/dev/null 2>&1; then
        wget -q --show-progress -O "$TEMP_UPDATE" "$UPDATE_URL"
        DOWNLOAD_EXIT=$?
    else
        echo "✗ Error: No download tool available (curl or wget required)"
        return 1
    fi
    
    if [ $DOWNLOAD_EXIT -ne 0 ] || [ ! -f "$TEMP_UPDATE" ]; then
        echo "✗ Download failed. Check your internet connection."
        rm -f "$TEMP_UPDATE"
        return 1
    fi
    
    echo ""
    echo "→ Installing update..."
    
    # Backup current version
    BACKUP_DIR="$BERRYPY_DIR.backup-$(date +%Y%m%d_%H%M%S)"
    cp -r "$BERRYPY_DIR" "$BACKUP_DIR" 2>/dev/null
    
    # Extract update directly into share/berrypy/
    if ! unzip -o -q "$TEMP_UPDATE" -d "$BERRYPY_DIR" 2>/dev/null; then
        echo "✗ Failed to extract update"
        echo "  Backup saved at: $BACKUP_DIR"
        rm -f "$TEMP_UPDATE"
        return 1
    fi
    
    # Clean up
    rm -f "$TEMP_UPDATE"
    
    echo "✓ BerryPy updated successfully!"
    echo ""
    echo "  Backup saved at: $(basename $BACKUP_DIR)"
    
    # Restart if it was running
    if [ $WAS_RUNNING -eq 1 ]; then
        echo ""
        echo "→ Restarting BerryPy..."
        sleep 1
        start_berrypy
    else
        echo ""
        echo "Run 'berrypy start' to launch the updated version"
    fi
}

# Main command handling
case "${1:-start}" in
    start)
        start_berrypy
        ;;
    stop)
        stop_berrypy
        ;;
    restart)
        stop_berrypy
        sleep 1
        start_berrypy
        ;;
    status)
        status_berrypy
        ;;
    logs)
        show_logs
        ;;
    url)
        echo "http://127.0.0.1:8001"
        ;;
    update)
        update_berrypy
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'berrypy help' for usage"
        exit 1
        ;;
esac
