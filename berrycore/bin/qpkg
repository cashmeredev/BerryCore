#!/bin/sh
# qpkg - QNX Package Manager for BerryCore
# Manage BerryCore updates and install additional ports

VERSION="0.1.0"
GITHUB_REPO="sw7ft/BerryCore"
GITHUB_API="https://api.github.com/repos/$GITHUB_REPO"
GITHUB_RAW="https://raw.githubusercontent.com/$GITHUB_REPO/main"
DOWNLOAD_DIR="/accounts/1000/shared/documents"

# Colors (if terminal supports it)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    BOLD=''
    NC=''
fi

# Helper functions
print_header() {
    echo ""
    echo "==========================================="
    echo "  $1"
    echo "==========================================="
    echo ""
}

print_success() {
    echo "${GREEN}✓${NC} $1"
}

print_error() {
    echo "${RED}✗${NC} $1"
}

print_info() {
    echo "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo "${YELLOW}⚠${NC} $1"
}

# Get current installed version
get_current_version() {
    if [ -f "$NATIVE_TOOLS/VERSION" ]; then
        cat "$NATIVE_TOOLS/VERSION"
    else
        echo "unknown"
    fi
}

# Check for updates via GitHub API
check_for_updates() {
    print_info "Checking for updates..."
    
    # Fetch latest release info
    RELEASE_JSON=$(curl -s -m 10 "$GITHUB_API/releases/latest" 2>/dev/null)
    
    if [ -z "$RELEASE_JSON" ]; then
        print_error "Failed to connect to GitHub. Check your internet connection."
        return 1
    fi
    
    # Parse version tag (remove 'v' prefix)
    LATEST_VERSION=$(echo "$RELEASE_JSON" | grep '"tag_name"' | sed 's/.*"v\([^"]*\)".*/\1/' | head -1)
    
    if [ -z "$LATEST_VERSION" ]; then
        print_error "Could not determine latest version."
        return 1
    fi
    
    echo "$LATEST_VERSION"
}

# Compare versions (simple string comparison)
version_greater() {
    # $1 = new version, $2 = old version
    # Returns 0 if $1 > $2
    
    # Simple comparison - works for x.y format
    NEW_MAJOR=$(echo "$1" | cut -d. -f1)
    NEW_MINOR=$(echo "$1" | cut -d. -f2)
    OLD_MAJOR=$(echo "$2" | cut -d. -f1)
    OLD_MINOR=$(echo "$2" | cut -d. -f2)
    
    if [ "$NEW_MAJOR" -gt "$OLD_MAJOR" ]; then
        return 0
    elif [ "$NEW_MAJOR" -eq "$OLD_MAJOR" ] && [ "$NEW_MINOR" -gt "$OLD_MINOR" ]; then
        return 0
    else
        return 1
    fi
}

# Download file with progress
download_file() {
    URL="$1"
    OUTPUT="$2"
    FILENAME=$(basename "$OUTPUT")
    
    print_info "Downloading $FILENAME..."
    
    # Try curl with progress bar
    if command -v curl >/dev/null 2>&1; then
        curl -L -o "$OUTPUT" "$URL" 2>&1 | \
        while read line; do
            echo "$line" | grep -o '[0-9]*\.[0-9]' | tail -1 | \
            while read pct; do
                printf "\r  Progress: %.0f%%" "$pct"
            done
        done
        printf "\r  Progress: 100%%\n"
    elif command -v wget >/dev/null 2>&1; then
        wget -O "$OUTPUT" "$URL"
    else
        print_error "No download tool available (curl or wget required)"
        return 1
    fi
    
    if [ -f "$OUTPUT" ]; then
        print_success "Downloaded $FILENAME"
        return 0
    else
        print_error "Download failed: $FILENAME"
        return 1
    fi
}

# Update BerryCore
cmd_update() {
    print_header "BerryCore Update Manager"
    
    CURRENT_VERSION=$(get_current_version)
    echo "Current version: ${BOLD}v${CURRENT_VERSION}${NC}"
    echo ""
    
    LATEST_VERSION=$(check_for_updates)
    if [ $? -ne 0 ]; then
        exit 1
    fi
    
    echo "Latest version:  ${BOLD}v${LATEST_VERSION}${NC}"
    echo ""
    
    # Compare versions
    if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
        print_success "You're already on the latest version!"
        exit 0
    fi
    
    if ! version_greater "$LATEST_VERSION" "$CURRENT_VERSION"; then
        print_info "Your version ($CURRENT_VERSION) is newer than the release ($LATEST_VERSION)"
        exit 0
    fi
    
    # New version available
    print_success "New version available: v${LATEST_VERSION}"
    echo ""
    
    # Fetch release notes
    RELEASE_BODY=$(curl -s "$GITHUB_API/releases/latest" | grep -A 50 '"body"' | sed '1d' | sed 's/^[[:space:]]*"//' | head -20)
    if [ -n "$RELEASE_BODY" ]; then
        echo "${BOLD}What's new:${NC}"
        echo "$RELEASE_BODY" | head -10
        echo ""
    fi
    
    # Confirm update
    echo -n "Download and install v${LATEST_VERSION}? [Y/n]: "
    read CONFIRM
    
    if [ "$CONFIRM" != "" ] && [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
        echo "Update cancelled."
        exit 0
    fi
    
    echo ""
    print_header "Downloading BerryCore v${LATEST_VERSION}"
    
    # Download URLs
    BERRYCORE_URL="https://github.com/$GITHUB_REPO/releases/download/v${LATEST_VERSION}/berrycore.zip"
    INSTALL_URL="https://github.com/$GITHUB_REPO/releases/download/v${LATEST_VERSION}/install.sh"
    
    # Download files
    cd "$DOWNLOAD_DIR" || exit 1
    
    download_file "$BERRYCORE_URL" "berrycore.zip"
    if [ $? -ne 0 ]; then
        print_error "Failed to download berrycore.zip"
        exit 1
    fi
    
    download_file "$INSTALL_URL" "install.sh"
    if [ $? -ne 0 ]; then
        print_error "Failed to download install.sh"
        exit 1
    fi
    
    chmod +x install.sh
    
    echo ""
    print_header "Installing BerryCore v${LATEST_VERSION}"
    
    # Run installer
    sh ./install.sh
    
    if [ $? -eq 0 ]; then
        echo ""
        print_success "BerryCore updated to v${LATEST_VERSION}!"
        echo ""
        echo "Restart your shell or run: source $NATIVE_TOOLS/env.sh"
    else
        print_error "Installation failed. Check errors above."
        exit 1
    fi
}

# Install a port (future implementation)
cmd_install() {
    PORT_NAME="$1"
    
    if [ -z "$PORT_NAME" ]; then
        print_error "Usage: qpkg install <package-name>"
        exit 1
    fi
    
    print_header "Installing Port: $PORT_NAME"
    
    print_info "Feature coming soon!"
    echo ""
    echo "This will download and install ports from:"
    echo "  $GITHUB_RAW/ports/"
    echo ""
    echo "For now, visit:"
    echo "  https://github.com/$GITHUB_REPO/tree/main/ports"
    echo ""
    echo "Manually download and install with:"
    echo "  cd $NATIVE_TOOLS"
    echo "  unzip -o /path/to/port-package.zip"
}

# Search for ports (future implementation)
cmd_search() {
    SEARCH_TERM="$1"
    
    if [ -z "$SEARCH_TERM" ]; then
        print_error "Usage: qpkg search <keyword>"
        exit 1
    fi
    
    print_header "Searching Ports"
    
    print_info "Feature coming soon!"
    echo ""
    echo "This will search the ports repository for: $SEARCH_TERM"
}

# List installed packages
cmd_list() {
    print_header "Installed Packages"
    
    if [ -d "$NATIVE_TOOLS/packages" ]; then
        ls -1 "$NATIVE_TOOLS/packages/" | sed 's/.zip$//' | nl
    else
        print_error "Packages directory not found"
    fi
}

# Show package info
cmd_info() {
    PACKAGE="$1"
    
    if [ -z "$PACKAGE" ]; then
        print_error "Usage: qpkg info <package-name>"
        exit 1
    fi
    
    print_header "Package Info: $PACKAGE"
    
    # Check if installed
    if [ -f "$NATIVE_TOOLS/packages/${PACKAGE}.zip" ]; then
        print_success "Installed: Yes"
        SIZE=$(ls -lh "$NATIVE_TOOLS/packages/${PACKAGE}.zip" | awk '{print $5}')
        echo "Size: $SIZE"
    else
        print_info "Not installed"
    fi
    
    # Check CATALOG
    if [ -f "$NATIVE_TOOLS/CATALOG" ]; then
        INFO=$(grep "^[^#]*|.*|.*${PACKAGE}" "$NATIVE_TOOLS/CATALOG" | head -1)
        if [ -n "$INFO" ]; then
            echo ""
            echo "Description:"
            echo "$INFO" | awk -F'|' '{print "  " $3}'
        fi
    fi
}

# Show help
cmd_help() {
    cat << EOF

${BOLD}qpkg${NC} - QNX Package Manager for BerryCore

${BOLD}USAGE:${NC}
  qpkg <command> [arguments]

${BOLD}COMMANDS:${NC}
  ${GREEN}update${NC}              Check for and install BerryCore updates
  ${YELLOW}install${NC} <package>   Install a port package (coming soon)
  ${YELLOW}search${NC} <keyword>    Search available ports (coming soon)
  list                List installed packages
  info <package>      Show package information
  help                Show this help message

${BOLD}EXAMPLES:${NC}
  qpkg update                  # Update BerryCore to latest version
  qpkg install python          # Install Python port (coming soon)
  qpkg search database         # Search for database packages
  qpkg list                    # List all installed packages
  qpkg info git                # Show info about git package

${BOLD}REPOSITORY:${NC}
  https://github.com/$GITHUB_REPO

${BOLD}VERSION:${NC}
  qpkg $VERSION

EOF
}

# Main command dispatcher
main() {
    COMMAND="$1"
    shift
    
    case "$COMMAND" in
        update)
            cmd_update "$@"
            ;;
        install)
            cmd_install "$@"
            ;;
        search)
            cmd_search "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        info)
            cmd_info "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        "")
            print_error "No command specified"
            echo "Run 'qpkg help' for usage information"
            exit 1
            ;;
        *)
            print_error "Unknown command: $COMMAND"
            echo "Run 'qpkg help' for available commands"
            exit 1
            ;;
    esac
}

# Run main
main "$@"

